# Бот для розыгрыша в Telegram канале

Этот бот позволяет проводить розыгрыши среди подписчиков Telegram канала.

## Возможности

- Создание постов с кнопкой "Участвую" и счетчиком участников
- Проверка подписки участников на канал (при регистрации и при розыгрыше)
- Поддержка изображений в постах розыгрышей
- Выбор количества победителей (от 1 до 10)
- Проведение розыгрыша среди подписчиков
- Объявление победителей с адаптивным форматированием
- Просмотр полной информации о розыгрышах
- Полная совместимость с мобильными устройствами

## Установка и настройка

### Стандартная установка

1. Клонируйте репозиторий:
```
git clone https://github.com/Rast53/raffle-bot.git
cd raffle-bot
```

2. Установите зависимости:
```
pip install -r requirements.txt
```

3. Создайте бота в Telegram через [@BotFather](https://t.me/BotFather) и получите токен

4. Создайте файл `.env` на основе `.env.example` и заполните его:
```
BOT_TOKEN=ваш_токен_бота
CHANNEL_USERNAME=имя_вашего_канала_с_@
```

5. Добавьте бота в администраторы вашего канала

6. Запустите бота:
```
python main.py
```

### Установка на NAS Synology с использованием Docker

1. Убедитесь, что на вашем NAS установлен Docker
   - Откройте Package Center на Synology DSM
   - Найдите и установите Docker

2. Клонируйте репозиторий на NAS или загрузите файлы через File Station.

3. Создайте файл `.env` на основе `.env.example` и заполните его данными:
```
BOT_TOKEN=ваш_токен_бота
CHANNEL_USERNAME=имя_вашего_канала_с_@
```

4. Подключитесь к NAS через SSH или используйте терминал Docker из DSM:

   **Вариант 1**: Использование Docker Compose (рекомендуется):
   ```
   cd /путь/к/папке/raffle-bot
   docker-compose up -d
   ```

   **Вариант 2**: Использование Docker напрямую:
   ```
   cd /путь/к/папке/raffle-bot
   docker build -t raffle-bot .
   docker run -d --name raffle-bot --restart always -v $(pwd)/data:/app/data -v $(pwd)/.env:/app/.env raffle-bot
   ```

5. Проверьте, что контейнер запущен:
   ```
   docker ps
   ```

### Управление Docker-контейнером

- Остановка бота:
  ```
  docker stop raffle-bot
  ```

- Запуск остановленного бота:
  ```
  docker start raffle-bot
  ```

- Просмотр логов:
  ```
  docker logs raffle-bot
  ```

- Просмотр логов в реальном времени:
  ```
  docker logs -f raffle-bot
  ```

## Использование

### Команды бота

- `/start` - Начать работу с ботом и получать личные уведомления
- `/create_raffle` - Создать новый розыгрыш
- `/list_raffles` - Показать список активных розыгрышей
- `/raffle_info` - Получить подробную информацию о розыгрыше
- `/draw_winner` - Определить победителей в розыгрыше
- `/reset` - Сбросить текущее состояние диалога (если бот перестал отвечать)
- `/cancel` - Отменить текущее действие при создании розыгрыша

### Создание розыгрыша

1. Отправьте команду `/create_raffle` боту
2. Отправьте текст розыгрыша (включая все условия и сроки)
3. Выберите, нужно ли добавить изображение (Да/Нет)
4. Если вы выбрали "Да", отправьте изображение
5. Укажите количество победителей (от 1 до 10)
6. Бот создаст пост в канале с кнопкой "Участвую" и вашим описанием

### Участие в розыгрыше

Пользователи могут участвовать в розыгрыше, нажав на кнопку "Участвую" под постом. При этом:

1. Бот проверяет, подписан ли пользователь на канал
2. Если пользователь подписан, он добавляется в список участников
3. Кнопка обновляется, показывая актуальное количество участников
4. Пользователь получает личное уведомление об успешной регистрации

Для получения личных уведомлений, пользователь должен предварительно начать диалог с ботом, отправив ему команду `/start`.

### Определение победителей

1. Отправьте команду `/draw_winner` боту
2. Выберите розыгрыш из списка активных розыгрышей
3. Бот проверит, что все участники всё ещё подписаны на канал
4. Из действующих подписчиков будут случайно выбраны победители (в количестве, указанном при создании)
5. Бот отправит сообщение с объявлением победителей в канал

### Просмотр информации о розыгрыше

1. Отправьте команду `/raffle_info` боту
2. Выберите розыгрыш из списка активных розыгрышей
3. Бот покажет подробную информацию о розыгрыше, включая:
   - Текст розыгрыша
   - Дату создания и окончания
   - Количество участников
   - Количество запланированных победителей
   - Полный список зарегистрированных участников

## Особенности и преимущества

- **Надежность**: Бот корректно обрабатывает все типы сообщений и ошибки
- **Гибкость**: Выбор количества победителей, поддержка изображений
- **Прозрачность**: Полная информация о розыгрышах и участниках
- **Честность**: Двойная проверка подписки (при регистрации и при розыгрыше)
- **Мобильность**: Полная совместимость с мобильными устройствами
- **Приватность**: Личные сообщения вместо публичных объявлений об ошибках
- **Восстановление**: Команды `/reset` и `/cancel` для восстановления после ошибок

## Устранение неполадок

### Бот не отвечает при создании розыгрыша

Если бот перестал отвечать во время создания розыгрыша:

1. Отправьте команду `/reset`
2. Бот сбросит состояние диалога и подтвердит сброс
3. Начните создание розыгрыша заново

### Участники не получают личные сообщения

Для получения личных сообщений от бота:

1. Пользователь должен найти бота в поиске
2. Отправить боту команду `/start`
3. После этого личные уведомления будут приходить корректно

### Ошибки при определении победителей

Если при определении победителей возникают ошибки:

1. Проверьте, что в розыгрыше есть достаточное количество участников
2. Убедитесь, что указанное количество победителей не превышает количество активных участников
3. Проверьте логи на наличие дополнительной информации: `docker logs -f raffle-bot` 